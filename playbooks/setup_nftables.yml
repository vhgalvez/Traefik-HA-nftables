# playbooks\setup_nftables.yml
---
- name: ğŸ”§ Instalar y aplicar configuraciÃ³n completa de nftables en los nodos de Traefik
  hosts: load_balancers
  become: true

  vars:
    nftables_config_path: /etc/sysconfig/nftables.conf

  tasks:
    - name: ğŸ“¦ Instalar nftables si no estÃ¡ presente
      package:
        name: nftables
        state: present

    - name: ğŸ“ Asegurar directorio de configuraciÃ³n
      file:
        path: "{{ nftables_config_path | dirname }}"
        state: directory
        mode: "0755"

    - name: ğŸ“„ Copiar archivo de configuraciÃ³n nftables.conf
      copy:
        src: "../files/nftables.conf"
        dest: "{{ nftables_config_path }}"
        owner: root
        group: root
        mode: "0644"

    - name: âœ… Habilitar y arrancar nftables
      systemd:
        name: nftables
        enabled: true
        state: started

    - name: ğŸš€ Aplicar reglas con nft directamente
      command: "nft -f {{ nftables_config_path }}"