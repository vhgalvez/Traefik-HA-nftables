# playbooks/setup_nftables.yml
---
- name: ğŸ”§ Instalar y aplicar configuraciÃ³n completa de nftables en los nodos de Traefik
  hosts: load_balancers
  become: true

  vars:
    nftables_config_path: /etc/sysconfig/nftables.conf

  tasks:
    - name: ğŸ“¦ Instalar nftables si no estÃ¡ presente
      package:
        name: nftables
        state: present

    - name: ğŸ“ Asegurar directorio de configuraciÃ³n
      file:
        path: "{{ nftables_config_path | dirname }}"
        state: directory
        mode: "0755"

    - name: ğŸ“„ Copiar archivo de configuraciÃ³n nftables.conf
      copy:
        src: "../files/nftables.conf"
        dest: "{{ nftables_config_path }}"
        owner: root
        group: root
        mode: "0644"

    - name: ğŸ” Verificar si el servicio nftables existe
      stat:
        path: /usr/lib/systemd/system/nftables.service
      register: nft_service

    - name: âœ… Intentar habilitar y arrancar nftables con systemd (opcional)
      systemd:
        name: nftables
        enabled: true
        state: started
      register: nft_start_result
      failed_when: false
      when: nft_service.stat.exists | default(false)

    - name: ğŸš€ Aplicar reglas directamente con nft como respaldo
      command: "nft -f {{ nftables_config_path }}"
      when: nft_start_result is not defined or nft_start_result.failed

    - name: ğŸ” Verificar reglas cargadas
      command: "nft list ruleset"
      register: nft_rules_output

    - name: ğŸ–¨ï¸ Mostrar reglas activas
      debug:
        var: nft_rules_output.stdout_lines